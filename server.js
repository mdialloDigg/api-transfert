const express=require('express');
const mongoose=require('mongoose');
const session=require('express-session');
const bcrypt=require('bcryptjs');
const PDFDocument=require('pdfkit');
const ExcelJS=require('exceljs');
const app=express();
app.use(express.urlencoded({extended:true}));
app.use(express.json());
app.use(session({secret:'transfert-secret-final',resave:false,saveUninitialized:true}));

mongoose.connect(process.env.MONGODB_URI||'mongodb://127.0.0.1:27017/transfert')
.then(()=>console.log('MongoDB connect√©')).catch(console.error);

const transfertSchema=new mongoose.Schema({
userType:{type:String,enum:['Client','Distributeur','Administrateur','Agence de transfert'],required:true},
senderFirstName:String,senderLastName:String,senderPhone:String,originLocation:String,
receiverFirstName:String,receiverLastName:String,receiverPhone:String,destinationLocation:String,
amount:Number,fees:Number,recoveryAmount:Number,currency:{type:String,enum:['GNF','EUR','USD','XOF'],default:'GNF'},
recoveryMode:String,retraitHistory:[{date:Date,mode:String}],retired:{type:Boolean,default:false},
code:{type:String,unique:true},createdAt:{type:Date,default:Date.now}
});
const Transfert=mongoose.model('Transfert',transfertSchema);

const authSchema=new mongoose.Schema({username:String,password:String,role:{type:String,enum:['admin','retrait'],default:'retrait'}});
const Auth=mongoose.model('Auth',authSchema);

async function generateUniqueCode(){let code,exists=true;while(exists){const letter=String.fromCharCode(65+Math.floor(Math.random()*26));const number=Math.floor(100+Math.random()*900);code=`${letter}${number}`;exists=await Transfert.findOne({code}).exec();}return code;}

const locations=['France','Belgique','Conakry','Suisse','Atlanta','New York','Allemagne'];
const currencies=['GNF','EUR','USD','XOF'];
const retraitModes=['Esp√®ces','Virement','Orange Money','Wave'];
const requireLogin=(req,res,next)=>{if(req.session.user)return next();res.redirect('/login');};
function setPermissions(role){if(role==='admin')return {lecture:true,ecriture:true,retrait:true,modification:true,suppression:true,imprimer:true};if(role==='retrait')return {lecture:true,ecriture:false,retrait:true,modification:false,suppression:false,imprimer:true};return {lecture:false,ecriture:false,retrait:false,modification:false,suppression:false,imprimer:false};}

app.get('/login',(req,res)=>{res.send(`<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><style>body{margin:0;font-family:Arial;background:linear-gradient(135deg,#ff8c42,#ffa64d);display:flex;justify-content:center;align-items:center;height:100vh;}.login-container{background:white;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);width:90%;max-width:360px;text-align:center;}.login-container h2{margin-bottom:30px;font-size:26px;color:#ff8c42;}.login-container input{width:100%;padding:15px;margin:10px 0;border:1px solid #ccc;border-radius:10px;font-size:16px;}.login-container button{padding:15px;width:100%;border:none;border-radius:10px;font-size:16px;background:#ff8c42;color:white;font-weight:bold;cursor:pointer;transition:0.3s;}.login-container button:hover{background:#e67300;}</style></head><body><div class="login-container"><h2>Connexion</h2><form method="post"><input name="username" placeholder="Utilisateur" required><input type="password" name="password" placeholder="Mot de passe" required><button>Se connecter</button></form></div></body></html>`);});

app.post('/login',async(req,res)=>{const {username,password}=req.body;let user=await Auth.findOne({username}).exec();if(!user){const hashed=bcrypt.hashSync(password,10);user=await new Auth({username,password:hashed,role:'retrait'}).save();}if(!bcrypt.compareSync(password,user.password))return res.send('Mot de passe incorrect');req.session.user={username:user.username,role:user.role,permissions:setPermissions(user.role)};res.redirect('/transferts/list');});
app.get('/logout',(req,res)=>{req.session.destroy(()=>res.redirect('/login'));});

app.get('/transferts/form',requireLogin,async(req,res)=>{if(!req.session.user.permissions.ecriture)return res.status(403).send('Acc√®s refus√©');let t=null;if(req.query.code)t=await Transfert.findOne({code:req.query.code});const code=t?t.code:await generateUniqueCode();res.send(`<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><style>body{font-family:Arial;background:#f0f4f8;margin:0;padding:10px;}.container{max-width:900px;margin:20px auto;padding:20px;background:#fff;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.2);}form{display:grid;gap:15px;}label{font-weight:bold;margin-bottom:5px;display:block;}input,select{padding:12px;border-radius:8px;border:1px solid #ccc;width:100%;font-size:16px;}input[readonly]{background:#e9ecef;}button{padding:15px;background:#ff8c42;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;}</style></head><body><div class="container"><h2>${t?'Modifier':'Nouveau'} Transfert</h2><form method="post"><label>Code</label><input name="code" value="${code}" readonly><label>Type</label><select name="userType"><option ${t&&t.userType==='Client'?'selected':''}>Client</option><option ${t&&t.userType==='Distributeur'?'selected':''}>Distributeur</option><option ${t&&t.userType==='Administrateur'?'selected':''}>Administrateur</option><option ${t&&t.userType==='Agence de transfert'?'selected':''}>Agence de transfert</option></select><label>Exp√©diteur Pr√©nom</label><input name="senderFirstName" value="${t?t.senderFirstName:''}" required><label>Exp√©diteur Nom</label><input name="senderLastName" value="${t?t.senderLastName:''}" required><label>Exp√©diteur T√©l√©phone</label><input name="senderPhone" value="${t?t.senderPhone:''}" required><label>Origine</label><select name="originLocation">${locations.map(v=>`<option ${t&&t.originLocation===v?'selected':''}>${v}</option>`).join('')}</select><label>Destinataire Pr√©nom</label><input name="receiverFirstName" value="${t?t.receiverFirstName:''}" required><label>Destinataire Nom</label><input name="receiverLastName" value="${t?t.receiverLastName:''}" required><label>Destinataire T√©l√©phone</label><input name="receiverPhone" value="${t?t.receiverPhone:''}" required><label>Destination</label><select name="destinationLocation">${locations.map(v=>`<option ${t&&t.destinationLocation===v?'selected':''}>${v}</option>`).join('')}</select><label>Montant</label><input type="number" id="amount" name="amount" value="${t?t.amount:''}" required><label>Frais</label><input type="number" id="fees" name="fees" value="${t?t.fees:''}" required><label>Montant √† recevoir</label><input type="text" id="recoveryAmount" name="recoveryAmount" readonly value="${t?t.recoveryAmount:''}"><label>Devise</label><select name="currency">${currencies.map(c=>`<option ${t&&t.currency===c?'selected':''}>${c}</option>`).join('')}</select><label>Mode de retrait</label><select name="recoveryMode">${retraitModes.map(m=>`<option ${t&&t.recoveryMode===m?'selected':''}>${m}</option>`).join('')}</select><button>${t?'Enregistrer Modifications':'Enregistrer'}</button></form><a href="/transferts/list">‚¨Ö Retour liste</a><script>const amountField=document.getElementById('amount');const feesField=document.getElementById('fees');const recoveryField=document.getElementById('recoveryAmount');function updateRecovery(){recoveryField.value=(parseFloat(amountField.value)||0)-(parseFloat(feesField.value)||0);}amountField.addEventListener('input',updateRecovery);feesField.addEventListener('input',updateRecovery);updateRecovery();</script></div></body></html>`;});

app.post('/transferts/form',requireLogin,async(req,res)=>{if(!req.session.user.permissions.ecriture)return res.status(403).send('Acc√®s refus√©');const amount=Number(req.body.amount||0);const fees=Number(req.body.fees||0);const recoveryAmount=amount-fees;const code=req.body.code||await generateUniqueCode();let existing=await Transfert.findOne({code});if(existing)await Transfert.findByIdAndUpdate(existing._id,{...req.body,amount,fees,recoveryAmount});else await new Transfert({...req.body,amount,fees,recoveryAmount,retraitHistory:[],code}).save();res.redirect('/transferts/list');});

app.get('/transferts/list',requireLogin,async(req,res)=>{
const {search='',status='all',page=1}=req.query;
let transferts=await Transfert.find().sort({createdAt:-1});
const s=search.toLowerCase();
transferts=transferts.filter(t=>t.code.toLowerCase().includes(s)||t.senderFirstName.toLowerCase().includes(s)||t.senderLastName.toLowerCase().includes(s)||t.senderPhone.toLowerCase().includes(s)||t.receiverFirstName.toLowerCase().includes(s)||t.receiverLastName.toLowerCase().includes(s)||t.receiverPhone.toLowerCase().includes(s));
if(status==='retire')transferts=transferts.filter(t=>t.retired);else if(status==='non')transferts=transferts.filter(t=>!t.retired);
const limit=20;const totalPages=Math.ceil(transferts.length/limit);const paginated=transferts.slice((page-1)*limit,page*limit);
const totals={};paginated.forEach(t=>{if(!totals[t.destinationLocation])totals[t.destinationLocation]={};if(!totals[t.destinationLocation][t.currency])totals[t.destinationLocation][t.currency]={amount:0,fees:0,recovery:0};totals[t.destinationLocation][t.currency].amount+=t.amount;totals[t.destinationLocation][t.currency].fees+=t.fees;totals[t.destinationLocation][t.currency].recovery+=t.recoveryAmount;});
let html=`<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><style>body{font-family:Arial;background:#f4f6f9;margin:0;padding:20px;}table{width:100%;border-collapse:collapse;background:white;margin-bottom:20px;}th,td{border:1px solid #ccc;padding:6px;text-align:left;font-size:14px;}th{background:#ff8c42;color:white;}.retired{background:#fff3b0;}button{padding:5px 8px;border:none;border-radius:6px;color:white;cursor:pointer;font-size:12px;margin-right:3px;}.modify{background:#28a745;}.delete{background:#dc3545;}.retirer{background:#ff9900;}.imprimer{background:#17a2b8;}a{margin-right:10px;text-decoration:none;color:#007bff;}</style></head><body><h2>üìã Liste des transferts</h2><div id="totaux"><h3>üìä Totaux par destination/devise</h3><table><thead><tr><th>Destination</th><th>Devise</th><th>Montant</th><th>Frais</th><th>Re√ßu</th></tr></thead><tbody>`;
for(let dest in totals){for(let curr in totals[dest]){html+=`<tr><td>${dest}</td><td>${curr}</td><td>${totals[dest][curr].amount}</td><td>${totals[dest][curr].fees}</td><td>${totals[dest][curr].recovery}</td></tr>`;}}
html+='</tbody></table></div>';
html+=`<form id="filterForm"><input type="text" name="search" placeholder="Recherche..." value="${search}"><select name="status"><option value="all" ${status==='all'?'selected':''}>Tous</option><option value="retire" ${status==='retire'?'selected':''}>Retir√©s</option><option value="non" ${status==='non'?'selected':''}>Non retir√©s</option></select><button type="submit">üîç Filtrer</button>`;
if(req.session.user.permissions.ecriture)html+=`<a href="/transferts/form">‚ûï Nouveau</a>`;
html+=`<a href="/transferts/pdf">üìÑ PDF</a><a href="/transferts/excel">üìä Excel</a><a href="/transferts/word">üìù Word</a><a href="/logout">üö™ D√©connexion</a></form>`;
html+='<table><thead><tr><th>Code</th><th>Type</th><th>Exp√©diteur</th><th>Origine</th><th>Destinataire</th><th>Destination</th><th>Montant</th><th>Frais</th><th>Re√ßu</th><th>Devise</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
paginated.forEach(t=>{html+=`<tr class="${t.retired?'retired':''}" data-id="${t._id}"><td>${t.code}</td><td>${t.userType}</td><td>${t.senderFirstName} ${t.senderLastName} (${t.senderPhone})</td><td>${t.originLocation}</td><td>${t.receiverFirstName} ${t.receiverLastName} (${t.receiverPhone})</td><td>${t.destinationLocation}</td><td>${t.amount}</td><td>${t.fees}</td><td>${t.recoveryAmount}</td><td>${t.currency}</td><td>${t.retired?'Retir√©':'Non retir√©'}</td><td>`;
if(req.session.user.permissions.modification)html+=`<a href="/transferts/form?code=${t.code}"><button class="modify">‚úèÔ∏è Modifier</button></a>`;
if(req.session.user.permissions.suppression)html+=`<button class="delete">‚ùå Supprimer</button>`;
if(req.session.user.permissions.retrait&&!t.retired)html+=`<select class="retirementMode">${retraitModes.map(m=>`<option>${m}</option>`).join('')}</select><button class="retirer">üí∞ Retirer</button>`;
if(req.session.user.permissions.imprimer)html+=`<a href="/transferts/print/${t._id}" target="_blank"><button class="imprimer">üñ® Imprimer</button></a>`;
html+='</td></tr>';});
html+='</tbody></table><div id="pagination">';
for(let i=1;i<=totalPages;i++)html+=`<a href="#" class="page" data-page="${i}">${i}</a> `;
html+='</div><script>async function postData(url,data){return fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});}document.querySelectorAll(".delete").forEach(btn=>btn.onclick=async()=>{if(confirm("‚ùå Confirmer?")){const tr=btn.closest("tr");await postData("/transferts/delete",{id:tr.dataset.id});tr.remove();}});document.querySelectorAll(".retirer").forEach(btn=>btn.onclick=async()=>{const tr=btn.closest("tr");const mode=tr.querySelector(".retirementMode").value;await postData("/transferts/retirer",{id:tr.dataset.id,mode});tr.querySelector("td:nth-child(11)").innerText="Retir√©";btn.remove();tr.querySelector(".retirementMode").remove();});document.getElementById("filterForm").onsubmit=async(e)=>{e.preventDefault();const f=e.target;const s=f.search.value;const st=f.status.value;window.location.href='/transferts/list?search='+encodeURIComponent(s)+'&status='+st;};document.querySelectorAll(".page").forEach(p=>p.onclick=e=>{e.preventDefault();const page=p.dataset.page;window.location.href='/transferts/list?search=${encodeURIComponent(search)}&status=${status}&page='+page;});</script></body></html>`;
res.send(html);
});

app.post('/transferts/retirer',requireLogin,async(req,res)=>{if(!req.session.user.permissions.retrait)return res.status(403).send('Acc√®s refus√©');await Transfert.findByIdAndUpdate(req.body.id,{retired:true,recoveryMode:req.body.mode,$push:{retraitHistory:{date:new Date(),mode:req.body.mode}}});res.send({ok:true});});
app.post('/transferts/delete',requireLogin,async(req,res)=>{if(!req.session.user.permissions.suppression)return res.status(403).send('Acc√®s refus√©');await Transfert.findByIdAndDelete(req.body.id);res.send({ok:true});});

app.get('/transferts/print/:id',requireLogin,async(req,res)=>{const t=await Transfert.findById(req.params.id);if(!t)return res.send('Transfert introuvable');res.send(`<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><style>body{font-family:Arial;text-align:center;padding:10px;}.ticket{border:1px dashed #333;padding:10px;width:280px;margin:auto;}h3{color:#ff8c42;}</style></head><body><div class="ticket"><h3>Transfert ${t.code}</h3><p>${t.senderFirstName} ${t.senderLastName} (${t.senderPhone})</p><p>${t.receiverFirstName} ${t.receiverLastName} (${t.receiverPhone})</p><p>${t.originLocation} ‚û° ${t.destinationLocation}</p><p>Montant: ${t.amount} ${t.currency}</p><p>Frais: ${t.fees}</p><p>Re√ßu: ${t.recoveryAmount}</p><p>Mode retrait: ${t.recoveryMode||'-'}</p><p>Status: ${t.retired?'Retir√©':'Non retir√©'}</p></div><script>window.print();</script></body></html>`);});

app.get('/transferts/pdf',requireLogin,async(req,res)=>{const tfs=await Transfert.find().sort({createdAt:-1});const doc=new PDFDocument();res.setHeader('Content-Type','application/pdf');res.setHeader('Content-Disposition','attachment; filename=transferts.pdf');doc.pipe(res);doc.fontSize(16).text('Liste des transferts', {align:'center'});doc.moveDown();tfs.forEach(t=>{doc.fontSize(12).text(`${t.code} - ${t.senderFirstName} ${t.senderLastName} -> ${t.receiverFirstName} ${t.receiverLastName} | ${t.amount} ${t.currency} | Retir√©: ${t.retired}`)});doc.end();});

app.get('/transferts/excel',requireLogin,async(req,res)=>{const tfs=await Transfert.find().sort({createdAt:-1});const wb=new ExcelJS.Workbook();const ws=wb.addWorksheet('Transferts');ws.columns=[{header:'Code',key:'code'},{header:'Exp√©diteur',key:'sender'},{header:'Destinataire',key:'receiver'},{header:'Origine',key:'origin'},{header:'Destination',key:'destination'},{header:'Montant',key:'amount'},{header:'Frais',key:'fees'},{header:'Re√ßu',key:'recovery'},{header:'Devise',key:'currency'},{header:'Retir√©',key:'retired'}];tfs.forEach(t=>ws.addRow({code:t.code,sender:`${t.senderFirstName} ${t.senderLastName}`,receiver:`${t.receiverFirstName} ${t.receiverLastName}`,origin:t.originLocation,destination:t.destinationLocation,amount:t.amount,fees:t.fees,recovery:t.recoveryAmount,currency:t.currency,retired:t.retired?'Oui':'Non'}));res.setHeader('Content-Type','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');res.setHeader('Content-Disposition','attachment; filename=transferts.xlsx');wb.xlsx.write(res);});

app.get('/transferts/word',requireLogin,async(req,res)=>{const tfs=await Transfert.find().sort({createdAt:-1});let html=`<html><head><meta charset="utf-8"></head><body><h1>Liste des transferts</h1><table border="1"><tr><th>Code</th><th>Exp√©diteur</th><th>Destinataire</th><th>Origine</th><th>Destination</th><th>Montant</th><th>Frais</th><th>Re√ßu</th><th>Devise</th><th>Retir√©</th></tr>`;tfs.forEach(t=>{html+=`<tr><td>${t.code}</td><td>${t.senderFirstName} ${t.senderLastName}</td><td>${t.receiverFirstName} ${t.receiverLastName}</td><td>${t.originLocation}</td><td>${t.destinationLocation}</td><td>${t.amount}</td><td>${t.fees}</td><td>${t.recoveryAmount}</td><td>${t.currency}</td><td>${t.retired?'Oui':'Non'}</td></tr>`});html+='</table></body></html>';res.setHeader('Content-Type','application/msword');res.setHeader('Content-Disposition','attachment; filename=transferts.doc');res.send(html);});

app.listen(process.env.PORT||3000,()=>console.log('Server running'));
